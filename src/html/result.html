<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>結果</title>
    <link rel="stylesheet" href="../css/styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Zen+Maru+Gothic:wght@700;900&display=swap" rel="stylesheet">
    <style>
      /* スピナーのスタイル */
      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border-top-color: #ec407a;
        animation: spin 1s infinite linear;
        display: block;
        margin: 20px auto;
      }

      /* スピンアニメーション */
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* imgがロードされるまで非表示にする */
      img {
        display: none;
        max-width: 100%; /* 必要に応じて調整 */
      }

      /* ロード中の状態でスピナーを表示 */
      .image-container {
        position: relative;
      }

      .image-container img {
        display: none; /* ロードされるまで非表示 */
      }

      .image-container.loaded img {
        display: block; /* ロードされたら表示 */
      }

      .image-container.loaded .spinner {
        display: none; /* ロード後にスピナー非表示 */
      }
    </style>
  </head>
  <body>
    <div class="container -ex">
      <h1 class="end">結果発表</h1>

      <p id="character-stats" style="display: none"></p>
      <div class="yoko">
        <canvas id="myChart"></canvas>
        <script
          type="text/javascript"
          src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.5.1/chart.js"
        ></script>
        <script
          type="text/javascript"
          src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"
        ></script>
        <div class="image-container">
          <div class="spinner"></div>
          <img
            id="character-image"
            alt="キャラクター画像"
            class="character-image"
          />
        </div>
      </div>
      <a href="story.html"><button class="story-btn">物語へ</button></a>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
      // URLのパラメータからデータを取得
      const urlParams = new URLSearchParams(window.location.search);
      const luck = urlParams.get("luck"); // 攻撃力を運に変更
      const agility = urlParams.get("agility");
      const intelligence = urlParams.get("intelligence");
      const affection = urlParams.get("affection"); // 年齢を愛情に変更
      const size = urlParams.get("size");
      const softness = urlParams.get("softness");
      const message = urlParams.get("message");

      // チャートを生成
      var ctx = document.getElementById("myChart");
      var myChart = new Chart(ctx, {
        type: "radar",
        data: {
          labels: ["運", "敏捷性", "知性", "愛情", "大きさ", "柔らかさ"], // ラベルを更新
          datasets: [
            {
              label: "パラメータ",
              data: [luck, agility, intelligence, affection, size, softness], // データを更新
              backgroundColor: "rgba(236, 64, 122, 0.5)", // グラフ背景色
              borderColor: "rgba(236, 64, 122, 1)", // グラフボーダー色
              borderWidth: 3, // 線の太さを指定
            },
          ],
        },
        options: {
          maintainAspectRatio: true,
          scales: {
            r: {
              max: 100, // グラフの最大値
              min: 0, // グラフの最小値
              ticks: {
                stepSize: 20, // 目盛間隔
                display: false, // メモリのラベルを非表示にする
              },
              pointLabels: {
                font: {
                  size: 18, // ラベルの文字サイズを指定
                  weight: "bold", // ラベルの文字の太さ
                },
              },
            },
          },
          plugins: {
            legend: {
              display: false, // 凡例を非表示にする
            },
            datalabels: {
              color: "black", // ラベルの色
              anchor: "end", // ラベルの配置
              align: "start", // ラベルの配置
              offset: -20, // ラベルの配置
              formatter: function (value) {
                return value; // データの値を表示
              },
              font: {
                weight: "bold", // 文字の太さを変更
                size: 18, // 文字サイズを指定
              },
            },
          },
        },
        plugins: [ChartDataLabels], // プラグインを有効化
      });

      // 結果を表示
      //const resultText = `次のパラメータに基づいて日本風のかわいいキャラクターを生成してください: 運: ${luck}、敏捷性: ${agility}、知性: ${intelligence}、愛情: ${affection}、体格: ${size}、柔らかさ: ${softness}。ただし、これらのパラメータの数値や文字を表示しないでください。`; // 結果表示を更新
      const resultText = "次のメッセージのような日本風のかわいく、ゆらキャラのようなキャラクターを生成して下さい。\r\n・"
         + message;
      //console.log(resultText);
      document.getElementById("character-stats").textContent = resultText;

      var img = document.querySelector(".image-container img");
      var container = document.querySelector(".image-container");

      // 画像がロードされたときのイベント
      img.onload = function () {
        container.classList.add("loaded"); // loadedクラスを追加してスタイル変更
      };

      // resultText を使ってPOSTリクエストを送信
      $.ajax({
        type: "POST",
        url: "https://ishinomakihack2024.azurewebsites.net/api/CreateImage", // 指定されたターゲットURL
        contentType: "application/json",
        data: JSON.stringify({ message: resultText }), // resultTextの内容を送信
        dataType: "json",
      })
        .done(function (response) {
          console.log("Success:", response);

          if (response.status) {
            // 返ってきたBase64エンコードされた画像データを取得
            const base64Image = response.base64Image;

            // imgタグのsrc属性に画像データをセット
            $("#character-image").attr(
              "src",
              `data:image/png;base64,${base64Image}`
            );
          } else {
            console.error("Error: No image data found");
          }
        })
        .fail(function (jqXHR, textStatus, errorThrown) {
          console.error("Error:", textStatus, errorThrown);
        });
    </script>
  </body>
</html>
